<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="theme-color" content="#1e1e1e">
    <link rel="icon" href="icon-512.png" type="image/png"> 
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <title>Money Balance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212; --header-bg: #1e1e1e; --card-bg: #1e1e1e;
            --text-color: #ffffff; --text-secondary: #aaaaaa; --border-color: #333333;
            --accent-green: #4CAF50; --accent-red: #ff5252; --accent-yellow: #FFC107; --accent-blue: #2196F3;
            --shadow: 0 4px 6px rgba(0,0,0,0.3); --modal-bg: #2c2c2c;
        }
        body.light-mode {
            --bg-color: #f4f6f8; --header-bg: #ffffff; --card-bg: #ffffff;
            --text-color: #333333; --text-secondary: #666666; --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0,0,0,0.05); --modal-bg: #ffffff;
        }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #121212; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s;
        }
        .splash-logo { font-size: 5rem; position: relative; display: flex; align-items: flex-end; justify-content: center; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* PRIVACIDADE */
        body.privacy-active .sensitive { filter: blur(8px); transition: filter 0.3s; user-select: none; }
        body.privacy-active canvas, body.privacy-active .progress-fill { filter: blur(10px); opacity: 0.5; }
        
        /* REFOR√áO CSS CONTRA ZOOM AUTOM√ÅTICO */
        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding-top: 80px; transition: background-color 0.3s; display: flex; justify-content: center;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            /* COMANDO CSS PARA EVITAR GESTOS DE PIN√áA */
            touch-action: pan-x pan-y; 
        }

        .header-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; background-color: var(--header-bg);
            z-index: 100; box-shadow: var(--shadow); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: center;
            padding-top: env(safe-area-inset-top);
        }
        .header-content { width: 100%; height: 70px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; box-sizing: border-box; }
        
        .header-left { display: flex; align-items: center; gap: 12px; }
        .logo-container { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .app-name { font-size: 1.4rem; font-weight: 800; }
        
        .header-right { display: flex; gap: 20px; align-items: center; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-color); padding: 5px; transition: opacity 0.2s; }
        .icon-btn:hover { opacity: 0.8; }
        .icon-btn i { pointer-events: none; } 

        .app-container { width: 100%; max-width: 900px; padding: 20px 15px 120px 15px; box-sizing: border-box; display: flex; flex-direction: column; min-height: calc(100vh - 80px); padding-bottom: 100px; }
        
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background-color: var(--card-bg); padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); }
        .nav-btn { background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer; padding: 0 15px; }
        .current-month { font-weight: bold; color: var(--accent-green); text-transform: uppercase; }
        
        .balance-container { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .balance-card { background-color: var(--card-bg); border-radius: 12px; padding: 12px 5px; flex: 1; text-align: center; border: 1px solid var(--border-color); }
        .bal-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }
        .bal-value { font-size: 0.95rem; font-weight: bold; }
        
        .sort-control { display: flex; justify-content: flex-end; margin-bottom: 10px; gap: 10px; }
        .sort-btn {
            background: transparent; border: 1px solid var(--border-color);
            color: var(--text-secondary); padding: 5px 12px; border-radius: 20px;
            font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 5px;
            transition: all 0.3s;
        }
        .sort-btn:hover { border-color: var(--text-color); color: var(--text-color); }
        .sort-btn.active-check { border-color: var(--accent-green); color: var(--accent-green); background-color: rgba(76, 175, 80, 0.1); }

        .transaction-list { display: flex; flex-direction: column; gap: 12px; flex-grow: 1; }
        .list-divider { font-size: 0.75rem; color: var(--text-secondary); margin: 15px 0 5px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

        .card { background-color: var(--card-bg); padding: 15px; border-radius: 14px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); border-left-width: 5px; }
        .card.receita { border-left-color: var(--accent-green); }
        .card.despesa { border-left-color: var(--accent-red); }
        .card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .card-actions { display: flex; gap: 15px; margin-top: 5px; }
        .action-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; color: var(--text-secondary); }

        .dashboard-section { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 60px; margin-bottom: 20px; }
        .dash-card { background-color: var(--card-bg); padding: 20px; border-radius: 14px; border: 1px solid var(--border-color); box-shadow: var(--shadow); flex: 1; min-width: 300px; }
        
        /* GR√ÅFICO DASHBOARD */
        .chart-wrapper { display: flex; align-items: center; justify-content: center; width: 100%; height: 220px; }
        .chart-area { width: 50%; height: 100%; display: flex; justify-content: center; align-items: center; position: relative; }
        .chart-area canvas { cursor: pointer !important; }

        .legend-area { 
            width: 50%; height: 100%; 
            padding-left: 20px;
            display: none; 
            flex-direction: column; 
            justify-content: center;
            overflow-y: auto;
        }
        .legend-area::-webkit-scrollbar { display: none; }
        
        .custom-legend-item {
            display: flex; align-items: center; margin-bottom: 6px; 
            font-size: 0.65rem; 
            cursor: pointer; color: var(--text-color); transition: opacity 0.2s;
        }
        .custom-legend-item:hover { opacity: 0.7; }
        .legend-color-box { width: 10px; height: 10px; border-radius: 3px; margin-right: 6px; flex-shrink: 0; }
        .legend-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }

        .chart-selector { display: flex; justify-content: center; margin-bottom: 15px; background-color: var(--bg-color); border-radius: 8px; padding: 4px; border: 1px solid var(--border-color); width: fit-content; margin-left: auto; margin-right: auto; gap: 5px; }
        .chart-btn { background: none; border: none; color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
        .chart-btn.active { background-color: var(--card-bg); color: var(--text-color); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .health-title { font-size: 1rem; font-weight: bold; margin-bottom: 5px; color: var(--text-color); }
        .health-desc { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 20px; }
        .progress-container { width: 100%; height: 20px; background-color: var(--bg-color); border-radius: 10px; overflow: hidden; margin-bottom: 10px; border: 1px solid var(--border-color); }
        .progress-fill { height: 100%; width: 0%; background-color: var(--accent-green); transition: width 1s ease, background-color 0.5s; border-radius: 10px; }
        .health-stats { display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 5px; }
        .stat-val { font-weight: bold; }

        .fab { position: fixed; bottom: 30px; right: 20px; background-color: var(--accent-green); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; border: none; z-index: 99; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); }
        @media (min-width: 920px) { .fab { right: calc(50% - 430px); } }

        /* MODAIS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        
        #modalCad, #modalConfig { z-index: 1000; }
        #modalGerCat { z-index: 1100; }
        #modalSelCat, #modalSelFreq { z-index: 1150; }
        #modalAviso, #modalConfirmacao { z-index: 1300; }
        #modalEditOp, #modalExc, #modalDetalhes { z-index: 1200; } 

        .modal-content { background-color: var(--modal-bg); width: 100%; max-width: 450px; border-radius: 20px; padding: 25px; position: relative; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .form-group { margin-bottom: 15px; }
        
        input:not([type="radio"]), select { 
            width: 100%; padding: 14px; border-radius: 10px; 
            border: 1px solid var(--border-color); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            box-sizing: border-box; outline: none; font-size: 1rem;
            appearance: none; -webkit-appearance: none;
        }
        
        select {
            background-image: linear-gradient(45deg, transparent 50%, var(--text-color) 50%), linear-gradient(135deg, var(--text-color) 50%, transparent 50%);
            background-position: calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px);
            background-size: 5px 5px, 5px 5px;
            background-repeat: no-repeat;
        }

        .fake-select {
            width: 100%; padding: 14px; border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color); color: var(--text-color);
            box-sizing: border-box; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .fake-select:active { background-color: var(--card-bg); }

        .sel-item { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; }
        .sel-item:last-child { border-bottom: none; }
        .sel-item:hover { background-color: var(--bg-color); }

        .btn-save { width: 100%; padding: 15px; background-color: var(--accent-green); border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; box-sizing: border-box; font-size: 1rem; }
        .footer-credits { text-align: center; color: var(--text-color); font-size: 0.85rem; margin-top: 60px; margin-bottom: 20px; padding-bottom: 40px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; }
        
        hr { border: 0; border-top: 1px solid var(--border-color); margin: 20px 0; }
        .btn-outline { background: transparent; border: 1px solid var(--text-color); color: var(--text-color); margin-top: 10px; }
        .btn-danger { background: var(--accent-red); color: white; border: none; }
        .close-btn { float: right; background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer; line-height: 1; padding: 5px; }

        .detalhe-item { border-bottom: 1px solid var(--border-color); padding: 10px 0; display: flex; justify-content: space-between; }
        .detalhe-item:last-child { border-bottom: none; }

        .config-option { padding: 15px; background: #222; border-radius: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 15px; border: 1px solid #333; text-align: left; color: var(--text-color); }
        .config-option:active { background: #333; }
        .config-option i { font-size: 1.2rem; }
        .hidden-file { display: none; }
        body.light-mode .config-option { background: #f5f5f5; border-color: #ddd; color: #333; }
        body.light-mode .config-option:active { background: #e0e0e0; }

        .cat-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .cat-list-item:last-child { border-bottom: none; }
        .btn-del-cat { color: var(--accent-red); background: none; border: none; cursor: pointer; padding: 5px; }
        
        .radio-group { display: flex; gap: 20px; margin-top: 15px; font-size: 0.9rem; color: var(--text-secondary); align-items: center; }
        .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        input[type="radio"] { width: auto; margin: 0; padding: 0; transform: scale(1.3); }
    </style>
</head>
<body id="body">

    <div id="splash-screen">
        <div class="splash-logo" style="flex-direction: column; align-items: center;">
            <img src="logo.png" style="width: 180px; height: auto; margin-bottom: 30px; animation: bounce 1.5s infinite;"> 
        </div>
        <h2 style="color: white; font-family: sans-serif; margin: 0; letter-spacing: 2px;">MONEY BALANCE</h2>
    </div>

    <div class="header-wrapper">
        <div class="header-content">
            <div class="header-left">
                <div class="logo-container"><img src="logo.png" style="width: 50px; height: 50px;"></div>
                <div class="app-name">Money Balance</div>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="alternarPrivacidade()" title="Privacidade"><i class="fas fa-eye" id="eyeIcon"></i></button>
                <button class="icon-btn" onclick="abrirModalConfig()" title="Configura√ß√µes"><i class="fas fa-cog"></i></button>  
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="nav-bar">
            <button class="nav-btn" onclick="mudarMes(-1)">‚óÄ</button>
            <span class="current-month" id="mesDisplay">...</span>
            <button class="nav-btn" onclick="mudarMes(1)">‚ñ∂</button>
        </div>
        
        <div class="balance-container">
            <div class="balance-card"><div class="bal-label">Receitas</div><div class="bal-value sensitive" id="recDisp" style="color: var(--accent-green)">R$ 0,00</div></div>
            <div class="balance-card"><div class="bal-label">Despesas</div><div class="bal-value sensitive" id="despDisp" style="color: var(--accent-red)">R$ 0,00</div></div>
            <div class="balance-card"><div class="bal-label">Saldo</div><div class="bal-value sensitive" id="salDisp">R$ 0,00</div></div>
        </div>
        
        <div class="sort-control">
            <button id="btnAcumulado" class="sort-btn" onclick="alternarAcumulado()">
                <i class="far fa-square"></i> Acumular Saldo
            </button>
            <button id="btnSort" class="sort-btn" onclick="alternarOrdem()"><i class="fas fa-calendar-alt"></i> Por Data</button>
        </div>

        <div id="lista" class="transaction-list"></div>
        
        <div class="dashboard-section" id="painelInferior" style="display: none;">
            <div class="dash-card">
                <div style="text-align: center; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; font-weight: bold;">GASTOS POR CATEGORIA</div>
                
                <div class="chart-selector">
                    <button class="chart-btn active" id="btnPizza" onclick="alterarTipoGrafico('doughnut')">Pizza üçï</button>
                    <button class="chart-btn" id="btnBarra" onclick="alterarTipoGrafico('bar')">Barras üìä</button>
                </div>
                
                <div class="chart-wrapper">
                    <div class="chart-area"><canvas id="meuGrafico"></canvas></div>
                    <div id="htmlLegend" class="legend-area"></div>
                </div>
                
                <div style="text-align: center; font-size: 0.7rem; color: var(--text-secondary); margin-top: 10px;">(Toque no gr√°fico para ver detalhes)</div>
            </div>
            <div class="dash-card" style="display: flex; flex-direction: column; justify-content: center;">
                <div class="health-title">Sa√∫de Financeira</div>
                <div class="health-desc">Comprometimento da renda (exceto investimentos).</div>
                <div class="progress-container"><div id="progBar" class="progress-fill"></div></div>
                <div class="health-stats">
                    <span style="color: var(--text-secondary)">Comprometido:</span>
                    <span id="progText" class="stat-val sensitive">0%</span>
                </div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary); text-align: right;"><span id="msgSaude">...</span></div>
            </div>
        </div>

        <div class="footer-credits">made by JEFFERSON ELIAS</div>
    </div>

    <button class="fab" onclick="abrirModalCadastro(false)">+</button>

    <div id="modalCad" class="modal">
        <div class="modal-content">
            <button onclick="fecharModal('modalCad')" class="close-btn">√ó</button>
            <h2 id="tituloModal" style="margin-top: 0">Nova Transa√ß√£o</h2>
            <input type="hidden" id="editId">
            <div class="form-group"><select id="tipo"><option value="Despesa">Despesa üî¥</option><option value="Receita">Receita üü¢</option></select></div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="number" id="valor" placeholder="Valor" step="0.01" inputmode="decimal">
                <input type="date" id="data">
            </div>
            <div class="form-group">
                <input type="hidden" id="cat">
                <div id="catDisplay" class="fake-select" onclick="abrirModalSelecao()">
                    <span>Selecione...</span> <i class="fas fa-chevron-down" style="font-size:0.8rem"></i>
                </div>
            </div>
            <div class="form-group"><input type="text" id="desc" placeholder="Descri√ß√£o (Obrigat√≥rio)"></div>
            <div id="secaoFreq">
                <div class="form-group">
                    <input type="hidden" id="freq" value="Unico">
                    <div id="freqDisplay" class="fake-select" onclick="abrirModalFreq()">
                        <span>√önico</span> <i class="fas fa-chevron-down" style="font-size:0.8rem"></i>
                    </div>
                </div>
                <div id="divParc" style="display: none; margin-bottom: 15px;">
                    <input type="number" id="numParc" value="2" placeholder="N¬∫ Parcelas">
                    <div class="radio-group">
                        <label><input type="radio" name="calcMode" value="total" checked> Valor Total</label>
                        <label><input type="radio" name="calcMode" value="parcela"> Valor da Parcela</label>
                    </div>
                </div>
            </div>
            <button class="btn-save" onclick="salvar()">Salvar</button>
        </div>
    </div>

    <div id="modalSelCat" class="modal">
        <div class="modal-content">
            <button onclick="fecharModal('modalSelCat')" class="close-btn">√ó</button>
            <h3 style="margin-top: 0">Categoria</h3>
            <div id="listaSelCat" style="max-height: 300px; overflow-y: auto; margin-top:10px;"></div>
            <hr>
            <button class="btn-save btn-outline" onclick="abrirGerenciarCat('transacao')">‚ûï Gerenciar / Nova...</button>
        </div>
    </div>

    <div id="modalSelFreq" class="modal">
        <div class="modal-content">
            <button onclick="fecharModal('modalSelFreq')" class="close-btn">√ó</button>
            <h3 style="margin-top: 0">Frequ√™ncia</h3>
            <div class="sel-item" onclick="selecionarFreq('Unico', '√önico')">√önico</div>
            <div class="sel-item" onclick="selecionarFreq('Parcelado', 'Parcelado')">Parcelado</div>
            <div class="sel-item" onclick="selecionarFreq('Fixo', 'Fixo Mensal')">Fixo Mensal</div>
        </div>
    </div>

    <div id="modalDetalhes" class="modal">
        <div class="modal-content">
            <button onclick="fecharModal('modalDetalhes')" class="close-btn">√ó</button>
            <h3 id="detalhesTitulo" style="margin-top: 0">Detalhes</h3>
            <div id="detalhesLista" style="max-height: 300px; overflow-y: auto; margin-top: 15px;"></div>
        </div>
    </div>

    <div id="modalEditOp" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3>Editar S√©rie</h3>
            <p style="color: var(--text-secondary)">Como deseja aplicar esta altera√ß√£o?</p>
            <button class="btn-save" style="background: #444; margin-bottom: 10px;" onclick="confirmarEdicao('unico')">Apenas este m√™s</button>
            <button class="btn-save" style="background: #444; margin-bottom: 10px;" onclick="confirmarEdicao('futuros')">Este e futuros</button>
            <button class="btn-save" style="background: #444; margin-bottom: 10px;" onclick="confirmarEdicao('tudo')">Toda a s√©rie</button>
            <button onclick="fecharModal('modalEditOp')" class="btn-save btn-outline">Cancelar</button>
        </div>
    </div>

    <div id="modalExc" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 id="excTit">Excluir Item</h3>
            <div id="optExcSer">
                <button class="btn-save" style="background: #444; margin-bottom: 10px;" onclick="confirmarExclusao('unico')">Apenas este m√™s</button>
                <button class="btn-save" style="background: #444; margin-bottom: 10px;" onclick="confirmarExclusao('futuros')">Este e futuros</button>
                <button class="btn-save" style="background: #444; margin-bottom: 10px;" onclick="confirmarExclusao('tudo')">Toda a s√©rie</button>
            </div>
            <div id="optExcUni">
                <button class="btn-save btn-danger" onclick="confirmarExclusao('unico')">Sim, Excluir</button>
            </div>
            <button onclick="fecharModal('modalExc')" class="btn-save btn-outline">Cancelar</button>
        </div>
    </div>

    <div id="modalConfig" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0; margin-bottom: 20px; text-align: center;">Configura√ß√µes</h3>
            <div class="config-option" onclick="abrirGerenciarCat('config')">
                <i class="fas fa-tags" style="color: var(--accent-green)"></i>
                <div><div style="font-weight:bold">Categorias</div><small style="color:var(--text-secondary)">Adicionar ou remover</small></div>
            </div>
            <div class="config-option" onclick="alternarTema()">
                <i class="fas fa-adjust" style="color: #90a4ae"></i>
                <div><div style="font-weight:bold">Alternar Tema</div><small style="color:var(--text-secondary)">Claro / Escuro</small></div>
            </div>
            <div class="config-option" onclick="exportarDados()">
                <i class="fas fa-download" style="color:var(--accent-blue)"></i>
                <div><div style="font-weight:bold">Fazer Backup</div><small style="color:var(--text-secondary)">Salva Transa√ß√µes + Categorias</small></div>
            </div>
            <label for="inputImport" class="config-option">
                <i class="fas fa-upload" style="color:var(--accent-yellow)"></i>
                <div><div style="font-weight:bold">Restaurar Backup</div><small style="color:var(--text-secondary)">Carregar arquivo salvo</small></div>
            </label>
            <input type="file" id="inputImport" class="hidden-file" accept=".json" onchange="verificarImportacao(event)">
            <div class="config-option" onclick="confirmarLimpeza()" style="border-color:var(--accent-red)">
                <i class="fas fa-trash" style="color:var(--accent-red)"></i>
                <div><div style="font-weight:bold; color:var(--accent-red)">Apagar Tudo</div><small style="color:var(--text-secondary)">Zerar aplicativo</small></div>
            </div>
            <button class="btn-save btn-outline" style="width:100%; margin-top:10px" onclick="fecharModal('modalConfig')">Fechar</button>
        </div>
    </div>

    <div id="modalGerCat" class="modal">
        <div class="modal-content">
            <button onclick="fecharModal('modalGerCat')" class="close-btn">√ó</button>
            <h3 style="margin-top: 0">Minhas Categorias</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="novaCatInput" placeholder="Nova categoria..." style="flex:1">
                <button class="btn-save" style="width: auto; padding: 0 15px;" onclick="adicionarCategoria()">+</button>
            </div>
            <div id="listaCatsGer" style="max-height: 250px; overflow-y: auto; background: var(--bg-color); border-radius: 8px; border: 1px solid var(--border-color);"></div>
            <button class="btn-save btn-outline" style="width:100%; margin-top:15px" onclick="fecharModal('modalGerCat')">Voltar</button>
        </div>
    </div>

    <div id="modalAviso" class="modal"><div class="modal-content" style="text-align: center;"><h3 id="avisoTitulo">Aviso</h3><p id="avisoMsg" style="color: var(--text-secondary);">Mensagem...</p><button class="btn-save" onclick="fecharModal('modalAviso')">OK</button></div></div>
    <div id="modalConfirmacao" class="modal"><div class="modal-content" style="text-align: center;"><h3 id="confTitulo">Confirma√ß√£o</h3><p id="confMsg" style="color: var(--text-secondary);">Tem certeza?</p><button id="btnConfSim" class="btn-save btn-danger" style="margin-bottom: 10px;">Sim, Confirmar</button><button class="btn-save btn-outline" onclick="fecharModal('modalConfirmacao')">Cancelar</button></div></div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW fail', err));
        }

        const categoriasPadrao = ["Alimenta√ß√£o", "Carro", "Educa√ß√£o", "Extra", "Igreja", "Investimento", "Lazer", "Moradia", "Outros", "Presente", "Sal√°rio", "Sa√∫de", "Servi√ßos", "Transporte", "Vestu√°rio"];
        let transacoes = JSON.parse(localStorage.getItem('fin_jeff')) || [];
        let categorias = JSON.parse(localStorage.getItem('cat_jeff')) || [...categoriasPadrao];

        let dataRef = new Date();
        let chartObj = null;
        let itemAcao = null;
        let callbackConfirmacao = null;
        let tipoGraficoAtual = 'doughnut';
        let ordemAtual = 'data';
        let acumularSaldo = false; 
        const LIMITE_FATIAS = 6; 

        // --- BLOQUEIO DE ZOOM (JAVASCRIPT REFOR√áADO) ---
        // Bloqueia gesto de pin√ßa (dois dedos)
        document.addEventListener('touchmove', function (event) {
          if (event.scale !== 1) { event.preventDefault(); }
        }, { passive: false });

        // Bloqueia duplo toque r√°pido
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
          const now = (new Date()).getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, { passive: false });
        // ----------------------------------------------

        function mostrarAviso(titulo, msg) { document.getElementById('avisoTitulo').innerText = titulo; document.getElementById('avisoMsg').innerText = msg; document.getElementById('modalAviso').style.display = 'flex'; }
        function mostrarConfirmacao(titulo, msg, callback) { document.getElementById('confTitulo').innerText = titulo; document.getElementById('confMsg').innerText = msg; callbackConfirmacao = callback; document.getElementById('modalConfirmacao').style.display = 'flex'; }
        
        window.addEventListener('load', () => {
            document.getElementById('btnConfSim').onclick = function() { if (callbackConfirmacao) callbackConfirmacao(); fecharModal('modalConfirmacao'); };
            setTimeout(() => { const splash = document.getElementById('splash-screen'); splash.style.opacity = '0'; setTimeout(() => splash.style.visibility = 'hidden', 500); }, 1200);
            carregarPref(); render();
        });

        function carregarPref() {
            if (localStorage.getItem('tema') === 'light') document.body.classList.add('light-mode');
            if (localStorage.getItem('priv') === 'true') {
                document.body.classList.add('privacy-active');
                const icon = document.getElementById('eyeIcon');
                if(icon) { icon.className = 'fas fa-eye-slash'; icon.style.color = 'var(--accent-red)'; }
            }
            const savedType = localStorage.getItem('tipoGrafico');
            if (savedType) { tipoGraficoAtual = savedType; atualizarBotoesGrafico(); }
            
            if (localStorage.getItem('acumular_jeff') === 'true') {
                acumularSaldo = true;
                atualizarBotaoAcumulado();
            }
        }

        function alternarTema() { const isLight = document.body.classList.toggle('light-mode'); localStorage.setItem('tema', isLight ? 'light' : 'dark'); render(); }
        function alternarPrivacidade() { const isPriv = document.body.classList.toggle('privacy-active'); localStorage.setItem('priv', isPriv); const icon = document.getElementById('eyeIcon'); if(icon) { icon.className = isPriv ? 'fas fa-eye-slash' : 'fas fa-eye'; icon.style.color = isPriv ? 'var(--accent-red)' : 'var(--text-color)'; } }
        function alternarOrdem() { ordemAtual = (ordemAtual === 'data') ? 'alfa' : 'data'; const btn = document.getElementById('btnSort'); btn.innerHTML = (ordemAtual === 'data') ? '<i class="fas fa-calendar-alt"></i> Por Data' : '<i class="fas fa-sort-alpha-down"></i> Por Nome'; render(); }
        
        function alternarAcumulado() {
            acumularSaldo = !acumularSaldo;
            localStorage.setItem('acumular_jeff', acumularSaldo);
            atualizarBotaoAcumulado();
            render();
        }

        function atualizarBotaoAcumulado() {
            const btn = document.getElementById('btnAcumulado');
            if (acumularSaldo) {
                btn.innerHTML = '<i class="fas fa-check-square"></i> Acumular Saldo';
                btn.classList.add('active-check');
            } else {
                btn.innerHTML = '<i class="far fa-square"></i> Acumular Saldo';
                btn.classList.remove('active-check');
            }
        }

        function salvarCategorias() { localStorage.setItem('cat_jeff', JSON.stringify(categorias)); }
        
        window.abrirModalSelecao = function() { renderModalSelecao(); document.getElementById('modalSelCat').style.display = 'flex'; }
        function renderModalSelecao() { const lista = document.getElementById('listaSelCat'); lista.innerHTML = ''; const catsOrdenadas = [...categorias].sort((a, b) => a.localeCompare(b)); catsOrdenadas.forEach(c => { const div = document.createElement('div'); div.className = 'sel-item'; div.innerText = c; div.onclick = function() { selecionarCategoria(c); }; lista.appendChild(div); }); }
        window.selecionarCategoria = function(valor) { document.getElementById('cat').value = valor; const display = document.getElementById('catDisplay').querySelector('span'); if (display) display.innerText = valor; fecharModal('modalSelCat'); }
        
        window.abrirModalFreq = function() { document.getElementById('modalSelFreq').style.display = 'flex'; }
        window.selecionarFreq = function(valor, rotulo) {
            document.getElementById('freq').value = valor;
            document.querySelector('#freqDisplay span').innerText = rotulo;
            document.getElementById('divParc').style.display = (valor === 'Parcelado') ? 'block' : 'none';
            fecharModal('modalSelFreq');
        }

        window.abrirGerenciarCat = function(origem) { if (origem === 'config') fecharModal('modalConfig'); if (origem === 'transacao') fecharModal('modalSelCat'); const lista = document.getElementById('listaCatsGer'); lista.innerHTML = ''; categorias.sort((a, b) => a.localeCompare(b)).forEach(c => { const div = document.createElement('div'); div.className = 'cat-list-item'; div.innerHTML = `<span>${c}</span> <button class="btn-del-cat" onclick="removerCategoria('${c}')"><i class="fas fa-trash"></i></button>`; lista.appendChild(div); }); document.getElementById('modalGerCat').style.display = 'flex'; }
        window.adicionarCategoria = function() { const input = document.getElementById('novaCatInput'); const val = input.value.trim(); if(!val) return; if(categorias.includes(val)) return mostrarAviso("Ops", "Categoria j√° existe."); categorias.push(val); salvarCategorias(); selecionarCategoria(val); input.value = ''; abrirGerenciarCat('reload'); if(document.getElementById('modalCad').style.display === 'flex') fecharModal('modalGerCat'); }
        window.removerCategoria = function(nome) { mostrarConfirmacao("Excluir?", `Apagar categoria "${nome}"?`, function(){ categorias = categorias.filter(c => c !== nome); salvarCategorias(); const catAtual = document.getElementById('cat').value; if (catAtual === nome) { document.getElementById('cat').value = ""; document.querySelector('#catDisplay span').innerText = "Selecione..."; } abrirGerenciarCat('reload'); }); }

        function render() {
            const m = dataRef.getMonth(), y = dataRef.getFullYear();
            const meses = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
            document.getElementById('mesDisplay').innerText = `${meses[m]} / ${y}`;

            const filtrados = transacoes.filter(t => { const d = new Date(t.data + 'T00:00:00'); return d.getMonth()===m && d.getFullYear()===y; });
            const sortFunc = (a, b) => (ordemAtual === 'data') ? new Date(a.data) - new Date(b.data) : a.descricao.localeCompare(b.descricao);
            const receitas = filtrados.filter(t => t.tipo === 'Receita').sort(sortFunc);
            const despesas = filtrados.filter(t => t.tipo === 'Despesa').sort(sortFunc);
            
            const totalRec = receitas.reduce((acc, t) => acc + t.valor, 0);
            const totalDesp = despesas.reduce((acc, t) => acc + t.valor, 0);
            let saldoFinal = totalRec - totalDesp;

            let saldoAnterior = 0;
            if (acumularSaldo) {
                const inicioMesAtual = new Date(y, m, 1);
                transacoes.forEach(t => {
                    const dataT = new Date(t.data + 'T00:00:00');
                    if (dataT < inicioMesAtual) {
                        if (t.tipo === 'Receita') saldoAnterior += t.valor;
                        else saldoAnterior -= t.valor;
                    }
                });
                saldoFinal += saldoAnterior;
            }

            const listaEl = document.getElementById('lista'); listaEl.innerHTML = '';
            if (filtrados.length === 0) { listaEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); margin-top: 20px;">Sem lan√ßamentos</div>'; } 
            else {
                if (receitas.length > 0) { listaEl.innerHTML += `<div class="list-divider">Entradas üü¢</div>`; receitas.forEach(t => listaEl.appendChild(criarCard(t))); }
                if (despesas.length > 0) { listaEl.innerHTML += `<div class="list-divider">Sa√≠das üî¥</div>`; despesas.forEach(t => listaEl.appendChild(criarCard(t))); }
            }

            document.getElementById('recDisp').innerText = totalRec.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('despDisp').innerText = totalDesp.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            
            const elSal = document.getElementById('salDisp'); 
            elSal.innerText = saldoFinal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); 
            elSal.style.color = saldoFinal >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

            if (acumularSaldo) {
                 elSal.setAttribute('title', `Acumulado: Inclui R$ ${saldoAnterior.toFixed(2)} anteriores`);
            }

            const painel = document.getElementById('painelInferior');
            if (filtrados.length > 0) { painel.style.display = 'flex'; renderGrafico(despesas); renderSaude(totalRec, despesas); } 
            else { painel.style.display = 'none'; }
        }

        function criarCard(t) { const div = document.createElement('div'); div.className = `card ${t.tipo.toLowerCase()}`; div.innerHTML = `<div><b>${t.descricao}</b><br><small style="color:var(--text-secondary)">${t.categoria} ‚Ä¢ ${t.data.split('-').reverse().slice(0,2).join('/')}</small></div><div class="card-right"><span class="sensitive" style="font-weight:bold; color: ${t.tipo==='Receita'?'var(--accent-green)':'var(--accent-red)'}">R$ ${t.valor.toFixed(2)}</span><div class="card-actions"><button class="action-btn" onclick="altStatus('${t.id}')">${t.status==='Pago'?'<i class="fas fa-check-circle" style="color:var(--accent-green)"></i>':'<i class="fas fa-clock"></i>'}</button><button class="action-btn" style="color: var(--accent-yellow)" onclick="prepararEdicao('${t.id}')"><i class="fas fa-pen"></i></button><button class="action-btn" onclick="prepararExclusao('${t.id}')"><i class="fas fa-trash"></i></button></div></div>`; return div; }

        function alterarTipoGrafico(tipo) { tipoGraficoAtual = tipo; localStorage.setItem('tipoGrafico', tipo); atualizarBotoesGrafico(); render(); }
        function atualizarBotoesGrafico() { document.getElementById('btnPizza').className = `chart-btn ${tipoGraficoAtual === 'doughnut' ? 'active' : ''}`; document.getElementById('btnBarra').className = `chart-btn ${tipoGraficoAtual === 'bar' ? 'active' : ''}`; }

        function renderGrafico(despesas) {
            if (chartObj) chartObj.destroy();
            const cats = {};
            despesas.forEach(t => { if (t.categoria) { cats[t.categoria] = (cats[t.categoria] || 0) + t.valor; } });

            let sortedCats = Object.keys(cats).map(key => { return { categoria: key, valor: cats[key] }; });
            sortedCats.sort((a, b) => b.valor - a.valor);
            const totalGeral = sortedCats.reduce((a, b) => a + b.valor, 0);

            const palette = ['#36A2EB','#9966FF','#FF6384','#4BC0C0','#FF9F40','#FFCD56','#C9CBCF','#71B37C','#EC932F','#8D6E63'];

            let finalCats = sortedCats;
            if (tipoGraficoAtual === 'doughnut' && sortedCats.length > LIMITE_FATIAS) {
                const topCats = sortedCats.slice(0, LIMITE_FATIAS);
                const resto = sortedCats.slice(LIMITE_FATIAS);
                const somaResto = resto.reduce((acc, curr) => acc + curr.valor, 0);
                if (somaResto > 0) finalCats = [...topCats, { categoria: "Demais...", valor: somaResto }];
            }

            const labels = finalCats.map(item => item.categoria);
            const dataValues = finalCats.map(item => item.valor);
            
            const legendaDiv = document.getElementById('htmlLegend');
            const chartArea = document.querySelector('.chart-area');
            const textColor = document.body.classList.contains('light-mode') ? '#333' : '#fff';

            let scalesConfig = {};
            
            if (tipoGraficoAtual === 'bar') {
                legendaDiv.style.display = 'none';
                chartArea.style.width = '100%';
                scalesConfig = { x: { ticks: { color: textColor }, grid: { color: 'var(--border-color)' } }, y: { ticks: { color: textColor, autoSkip: false }, grid: { display: false } } };
            } else {
                legendaDiv.style.display = 'flex';
                chartArea.style.width = '50%';
                scalesConfig = { x: { display: false }, y: { display: false } };
                
                legendaDiv.innerHTML = '';
                finalCats.forEach((item, i) => {
                    const color = palette[i % palette.length];
                    const perc = totalGeral > 0 ? ((item.valor / totalGeral) * 100).toFixed(1) + '%' : '0%';
                    const div = document.createElement('div');
                    div.className = 'custom-legend-item';
                    
                    div.innerHTML = `<div class="legend-color-box" style="background-color:${color}"></div><div class="legend-text">${item.categoria} (${perc})</div>`;
                    
                    div.onclick = function() {
                        if (item.categoria === "Demais...") {
                            const topNames = finalCats.map(c => c.categoria).filter(n => n !== "Demais...");
                            mostrarDetalhesCategoria(null, topNames); 
                        } else {
                            mostrarDetalhesCategoria(item.categoria);
                        }
                    };
                    legendaDiv.appendChild(div);
                });
            }

            chartObj = new Chart(document.getElementById('meuGrafico'), {
                type: tipoGraficoAtual,
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: palette,
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: tipoGraficoAtual === 'bar' ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = totalGeral > 0 ? ((value / totalGeral) * 100).toFixed(1) + '%' : '0%';
                                    return context.label + ': ' + value.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) + ' (' + percentage + ')';
                                }
                            }
                        }
                    },
                    scales: scalesConfig,
                    onClick: (e, elements) => {
                        if(elements.length > 0) {
                            const i = elements[0].index;
                            const cat = labels[i];
                            if (cat === "Demais...") {
                                const topNames = finalCats.map(c => c.categoria).filter(n => n !== "Demais...");
                                mostrarDetalhesCategoria(null, topNames); 
                            } else {
                                mostrarDetalhesCategoria(cat);
                            }
                        }
                    }
                }
            });
        }

        function mostrarDetalhesCategoria(categoria, exclusoes = null) {
            const m = dataRef.getMonth(), y = dataRef.getFullYear();
            let itens = [];
            if (exclusoes) { itens = transacoes.filter(t => t.tipo === 'Despesa' && !exclusoes.includes(t.categoria) && new Date(t.data + 'T00:00:00').getMonth() === m && new Date(t.data + 'T00:00:00').getFullYear() === y); document.getElementById('detalhesTitulo').innerText = "Demais Categorias"; } 
            else { itens = transacoes.filter(t => t.tipo === 'Despesa' && t.categoria === categoria && new Date(t.data + 'T00:00:00').getMonth() === m && new Date(t.data + 'T00:00:00').getFullYear() === y); document.getElementById('detalhesTitulo').innerText = categoria; }
            itens.sort((a,b) => new Date(a.data) - new Date(b.data)); const lista = document.getElementById('detalhesLista'); lista.innerHTML = '';
            if (itens.length === 0) { lista.innerHTML = '<p style="text-align:center">Nenhum item.</p>'; } 
            else { itens.forEach(t => { const div = document.createElement('div'); div.className = 'detalhe-item'; div.innerHTML = `<span>${exclusoes ? `<small>[${t.categoria}]</small> ` : ''}${t.descricao} <small style="color:var(--text-secondary)">(${t.data.split('-').reverse().slice(0,2).join('/')})</small></span><span style="font-weight:bold">R$ ${t.valor.toFixed(2)}</span>`; lista.appendChild(div); }); }
            document.getElementById('modalDetalhes').style.display = 'flex';
        }

        function renderSaude(rec, desp) {
            const dReal = desp.filter(t => t.categoria !== 'Investimento' && t.categoria !== 'Investimentos'); const dTotal = dReal.reduce((acc, t) => acc + t.valor, 0); const perc = rec > 0 ? (dTotal / rec) * 100 : 0;
            const bar = document.getElementById('progBar'); bar.style.width = Math.min(perc, 100) + '%'; document.getElementById('progText').innerText = perc.toFixed(1) + '%';
            const msg = document.getElementById('msgSaude'); if (perc < 50) { bar.style.backgroundColor = 'var(--accent-blue)'; msg.innerText = "Finan√ßas sob controle! üîµ"; } else if (perc < 80) { bar.style.backgroundColor = 'var(--accent-yellow)'; msg.innerText = "Aten√ß√£o aos gastos. üü°"; } else { bar.style.backgroundColor = 'var(--accent-red)'; msg.innerText = "Cuidado! Renda comprometida. üî¥"; }
        }

        window.abrirModalCadastro = function(edit) { 
            document.getElementById('modalCad').style.display = 'flex'; 
            if (!edit) { 
                document.getElementById('tituloModal').innerText = "Nova Transa√ß√£o"; 
                document.getElementById('editId').value = ""; 
                document.getElementById('desc').value = ""; 
                document.getElementById('valor').value = ""; 
                document.getElementById('data').valueAsDate = new Date(); 
                document.getElementById('secaoFreq').style.display = 'block'; 
                
                // Reset da frequ√™ncia
                selecionarFreq('Unico', '√önico');
                
                document.getElementById('numParc').value = '2'; 
                document.querySelector('input[name="calcMode"][value="total"]').checked = true; 
                const catsOrdenadas = [...categorias].sort((a, b) => a.localeCompare(b)); 
                selecionarCategoria(catsOrdenadas[0] || "Sem Categoria"); 
            } 
        }
        window.prepararEdicao = function(id) { const t = transacoes.find(x => x.id === id); document.getElementById('editId').value = t.id; document.getElementById('tipo').value = t.tipo; document.getElementById('valor').value = t.valor; document.getElementById('data').value = t.data; document.getElementById('desc').value = t.descricao; selecionarCategoria(t.categoria); document.getElementById('secaoFreq').style.display = 'none'; document.getElementById('tituloModal').innerText = "Editar Transa√ß√£o"; document.getElementById('modalCad').style.display = 'flex'; }
        window.salvar = function() { const id = document.getElementById('editId').value; const v = parseFloat(document.getElementById('valor').value); const d = document.getElementById('data').value; const ds = document.getElementById('desc').value; const c = document.getElementById('cat').value; if (isNaN(v) || v <= 0) return mostrarAviso("Erro", "Preencha o valor corretamente!"); if (!ds) return mostrarAviso("Erro", "Preencha a descri√ß√£o!"); if (!d) return mostrarAviso("Erro", "Preencha a data!"); if (!c) return mostrarAviso("Erro", "Selecione uma categoria!"); if (id) { const t = transacoes.find(x => x.id === id); if (t.seriesId) { itemAcao = t; document.getElementById('modalEditOp').style.display = 'flex'; } else { confirmarEdicao('unico'); } } else { const f = document.getElementById('freq').value; let q = f === 'Parcelado' ? parseInt(document.getElementById('numParc').value) : (f === 'Fixo' ? 60 : 1); let valFinal = v; if (f === 'Parcelado') { const modoParc = document.querySelector('input[name="calcMode"]:checked').value; if (modoParc === 'total') { valFinal = v / q; } else { valFinal = v; } } const sId = f==='Unico' ? null : crypto.randomUUID(); for (let i = 0; i < q; i++) { let dateObj = new Date(d + 'T00:00:00'); dateObj.setMonth(dateObj.getMonth() + i); transacoes.push({ id: crypto.randomUUID(), seriesId: sId, data: dateObj.toISOString().split('T')[0], valor: valFinal, tipo: document.getElementById('tipo').value, categoria: c, descricao: f==='Parcelado'?`${ds} (${i+1}/${q})`:ds, status: 'Pendente' }); } finalizar(); } }
        window.confirmarEdicao = function(m) { const id = document.getElementById('editId').value; const tOrig = transacoes.find(x => x.id === id); const nTipo = document.getElementById('tipo').value; const nValor = parseFloat(document.getElementById('valor').value); const nData = document.getElementById('data').value; const nCat = document.getElementById('cat').value; const nDesc = document.getElementById('desc').value; if (m === 'unico') { Object.assign(tOrig, { tipo: nTipo, valor: nValor, data: nData, categoria: nCat, descricao: nDesc }); } else { const novoDia = nData.split('-')[2]; transacoes.forEach(t => { if (t.seriesId === tOrig.seriesId) { if (m === 'futuros' && t.data < tOrig.data) return; t.tipo = nTipo; t.valor = nValor; t.categoria = nCat; let partes = t.data.split('-'); t.data = `${partes[0]}-${partes[1]}-${novoDia}`; } }); } finalizar(); }
        function finalizar() { localStorage.setItem('fin_jeff', JSON.stringify(transacoes)); fecharModal('modalCad'); fecharModal('modalEditOp'); render(); }
        window.fecharModal = function(id) { document.getElementById(id).style.display = 'none'; }
        window.mudarMes = function(v) { dataRef.setMonth(dataRef.getMonth() + v); render(); }
        window.altStatus = function(id) { const t = transacoes.find(x=>x.id===id); t.status = t.status==='Pago'?'Pendente':'Pago'; finalizar(); }
        window.prepararExclusao = function(id) { itemAcao = transacoes.find(x => x.id === id); document.getElementById('modalExc').style.display = 'flex'; if (itemAcao.seriesId) { document.getElementById('optExcSer').style.display = 'block'; document.getElementById('optExcUni').style.display = 'none'; } else { document.getElementById('optExcSer').style.display = 'none'; document.getElementById('optExcUni').style.display = 'block'; } }
        window.confirmarExclusao = function(m) { if (m === 'unico') { transacoes = transacoes.filter(x => x.id !== itemAcao.id); } else if (m === 'futuros') { transacoes = transacoes.filter(x => !(x.seriesId === itemAcao.seriesId && x.data >= itemAcao.data)); } else if (m === 'tudo') { transacoes = transacoes.filter(x => x.seriesId !== itemAcao.seriesId); } finalizar(); fecharModal('modalExc'); }
        window.abrirModalConfig = function() { document.getElementById('modalConfig').style.display = 'flex'; }
        window.exportarDados = function() { const pacoteBackup = { transacoes: transacoes, categorias: categorias }; if (transacoes.length === 0 && categorias.length === categoriasPadrao.length) return mostrarAviso("Vazio", "Sem dados relevantes."); const dados = JSON.stringify(pacoteBackup); const nome = `backup_money_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`; const blob = new Blob([dados], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = nome; document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(() => URL.revokeObjectURL(url), 100); }
        window.verificarImportacao = function(event) { const arquivo = event.target.files[0]; if (!arquivo) return; mostrarConfirmacao("Restaurar?", "Isso substituir√° tudo.", function() { const leitor = new FileReader(); leitor.onload = function(e) { try { const json = JSON.parse(e.target.result); if (Array.isArray(json)) { localStorage.setItem('fin_jeff', JSON.stringify(json)); } else if (json.transacoes && Array.isArray(json.transacoes)) { localStorage.setItem('fin_jeff', JSON.stringify(json.transacoes)); if (json.categorias && Array.isArray(json.categorias)) localStorage.setItem('cat_jeff', JSON.stringify(json.categorias)); } else { return mostrarAviso("Erro", "Arquivo inv√°lido."); } mostrarAviso("Sucesso", "Reiniciando..."); setTimeout(() => location.reload(), 2000); } catch (erro) { mostrarAviso("Erro", "Erro ao ler arquivo."); } }; leitor.readAsText(arquivo); }); event.target.value = ''; }
        window.confirmarLimpeza = function() { mostrarConfirmacao("Resetar?", "Apagar tudo?", function() { localStorage.removeItem('fin_jeff'); localStorage.removeItem('cat_jeff'); location.reload(); }); }
        window.onclick = e => { if (e.target.className.includes('modal')) { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); } }
    </script>
</body>
</html>
