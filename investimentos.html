<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Money Invest</title>
    
    <link rel="icon" href="icon-512.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- VARIÁVEIS --- */
        :root {
            --bg-color: #121212; --header-bg: #1e1e1e; --card-bg: #1e1e1e;
            --text-color: #ffffff; --text-secondary: #aaaaaa; --border-color: #333333;
            --accent-green: #4CAF50; --accent-red: #ff5252; --accent-yellow: #FFC107; --accent-blue: #2196F3;
            --input-bg: #262626; --modal-bg: #2c2c2c;
            --cat-header-bg: #262626;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        body.light-mode {
            --bg-color: #f4f6f8; --header-bg: #ffffff; --card-bg: #ffffff;
            --text-color: #333333; --text-secondary: #666666; --border-color: #e0e0e0;
            --input-bg: #f0f0f0; --modal-bg: #ffffff;
            --cat-header-bg: #e0e0e0;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        body { 
            background: var(--bg-color); color: var(--text-color); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 20px; margin: 0; display: flex; flex-direction: column; align-items: center; 
            padding-bottom: 100px; padding-top: 80px;
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.3s;
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #121212; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s;
        }
        .splash-logo { font-size: 5rem; position: relative; display: flex; align-items: flex-end; justify-content: center; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- CABEÇALHO --- */
        .header-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; background-color: var(--header-bg);
            z-index: 100; box-shadow: var(--shadow); border-bottom: 1px solid var(--border-color);
            display: flex; padding-top: env(safe-area-inset-top);
        }
        .header-content { 
            width: 100%; height: 70px; padding: 0 20px; 
            display: flex; align-items: center; justify-content: space-between; 
            box-sizing: border-box; 
        }
        .header-left .app-name { font-size: 1.2rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-right { display: flex; gap: 20px; align-items: center; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-color); padding: 5px; transition: opacity 0.2s; }
        .blur-text { filter: blur(8px); user-select: none; }
        body.privacy-active canvas { filter: blur(10px); opacity: 0.5; }

        /* --- CARDS E GRÁFICOS --- */
        .resumo-card { 
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--header-bg) 100%); 
            width: 100%; max-width: 600px; padding: 25px; border-radius: 20px; 
            margin-bottom: 20px; text-align: center; border: 1px solid var(--border-color); 
            box-sizing: border-box; box-shadow: var(--shadow);
        }
        .valor-total { font-size: 2rem; font-weight: bold; color: var(--text-color); margin: 10px 0; }
        
        .charts-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .chart-box { 
            background: var(--card-bg); padding: 15px; border-radius: 15px; 
            border: 1px solid var(--border-color); height: 320px; 
            position: relative; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        .chart-wrapper { position: relative; height: 260px; width: 100%; display: flex; justify-content: center; }
        h4 { margin: 0 0 10px 0; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; text-align: center; text-transform: uppercase; letter-spacing: 1px; width: 100%; }

        .btn-main { width: 100%; max-width: 600px; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; color: #fff; background: var(--accent-blue); cursor: pointer; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3); }
        
        /* --- LISTA DE ATIVOS COM SANFONA --- */
        .lista-ativos { width: 100%; max-width: 600px; }
        
        .categoria-wrapper { margin-bottom: 15px; border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); background: var(--card-bg); }
        .categoria-header {
            padding: 15px; background: var(--cat-header-bg); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px;
            color: var(--text-color); transition: background 0.2s;
        }
        .categoria-header:hover { opacity: 0.9; }
        .categoria-header i { transition: transform 0.3s; }
        .categoria-header.collapsed i { transform: rotate(-90deg); }
        
        .categoria-content { display: block; padding: 0 10px 10px 10px; }
        .categoria-content.hidden { display: none; }

        .ativo-card { 
            background: var(--input-bg); padding: 16px; border-radius: 12px; 
            margin-top: 10px; border: 1px solid var(--border-color); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .ativo-info h3 { margin: 0; font-size: 1rem; font-weight: 600; }
        .ativo-info small { color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 4px; }
        .ativo-valores { text-align: right; }
        .btn-cotacao { background: #333; border: 1px solid var(--border-color); color: #fff; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; margin-top: 5px; display: inline-flex; align-items: center; gap: 5px; }

        /* --- MODAIS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-content { background: var(--modal-bg); padding: 25px; border-radius: 24px; width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .form-title { font-size: 1.2rem; margin: 0 0 5px 0; color: var(--text-color); }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-row { display: flex; gap: 12px; }
        label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; margin-left: 2px; }
        
        input, select { 
            padding: 14px; background: var(--input-bg); border: 1px solid var(--border-color); 
            color: var(--text-color); border-radius: 12px; width: 100%; box-sizing: border-box; 
            font-size: 1rem; outline: none; transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--accent-blue); }

        .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-confirm { flex: 1; padding: 14px; border-radius: 12px; border: none; color: white; font-weight: bold; cursor: pointer; background: var(--accent-blue); }
        .btn-cancel { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); cursor: pointer; }
        .btn-danger { background: rgba(255, 82, 82, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red); flex: 1; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; }

        .loading-text { font-size: 0.75rem; color: var(--accent-green); display: none; margin-top: -5px; margin-bottom: 5px; }
        .helper-link { font-size: 0.75rem; color: var(--accent-blue); text-decoration: none; margin-top: -5px; display: none; cursor: pointer;}
        
        .config-option { 
            padding: 15px; background: var(--input-bg); border-radius: 12px; margin-bottom: 10px; 
            cursor: pointer; display: flex; align-items: center; gap: 15px; 
            border: 1px solid var(--border-color); color: var(--text-color);
        }
        .footer-credits { text-align: center; color: var(--text-color); font-size: 0.85rem; margin-top: 20px; padding-bottom: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; }
        .hidden-file { display: none; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo" style="flex-direction: column; align-items: center;">
            <img src="logo.png" style="width: 180px; height: auto; margin-bottom: 30px; animation: bounce 1.5s infinite;"> 
        </div>
        <h2 style="color: white; font-family: sans-serif; margin: 0; letter-spacing: 2px;">MONEY INVEST</h2>
    </div>

    <div class="header-wrapper">
        <div class="header-content">
            <div class="header-left">
                <div class="app-name">Carteira</div>
            </div>
            <div class="header-right">
                <a href="index.html" class="icon-btn" title="Ir para Finanças"><i class="fas fa-home"></i></a>
                <button class="icon-btn" onclick="togglePrivacidade()"><i class="fas fa-eye" id="eyeIcon"></i></button>
                <button class="icon-btn" onclick="abrirModalConfig()"><i class="fas fa-cog"></i></button>
            </div>
        </div>
    </div>

    <div class="resumo-card">
        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">Patrimônio Total</div>
        <div class="valor-total" id="totalDisplay">R$ 0,00</div>
        <div id="lucroTotalDisplay" style="font-size: 0.9rem; font-weight: bold; padding: 4px 10px; border-radius: 20px; display: inline-block;">---</div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <h4>Evolução Mensal</h4>
            <div class="chart-wrapper">
                <canvas id="graficoEvolucao"></canvas>
            </div>
        </div>
        <div class="chart-box">
            <h4>Alocação de Ativos</h4>
            <div class="chart-wrapper">
                <canvas id="graficoAlocacao"></canvas>
            </div>
        </div>
    </div>

    <button class="btn-main" onclick="abrirModalAdd()">+ Novo Investimento</button>

    <div id="listaAtivos" class="lista-ativos"></div>
    <div class="footer-credits">made by JEFFERSON ELIAS</div>

    <div id="modalAdd" class="modal">
        <div class="modal-content">
            <h3 class="form-title">Novo Ativo</h3>
            <input type="hidden" id="cryptoID"> 
            <div class="input-group">
                <label>Categoria</label>
                <select id="tipo" onchange="ajustarFormulario()">
                    <option value="Ação">Ações (B3)</option>
                    <option value="FII">FIIs</option>
                    <option value="Cripto">Criptomoedas</option>
                    <option value="ETF">ETFs</option>
                    <option value="RendaFixa">Renda Fixa</option>
                </select>
            </div>
            <div class="input-group">
                <label id="lblNome">Código / Nome</label>
                <input type="text" id="nomeAtivo" placeholder="Ex: PETR4" onblur="buscarCotacaoAoCadastrar()">
                <small id="loadingCotacao" class="loading-text">Buscando cotação...</small>
                <a id="stockLink" class="helper-link" target="_blank">Ver cotação ↗</a>
            </div>
            <div class="input-group" id="divTaxa" style="display:none">
                 <label>Taxa (% do CDI)</label>
                 <input type="text" id="taxa" placeholder="Ex: 100% CDI">
            </div>
            <div class="input-row">
                <div class="input-group" style="flex:1">
                    <label id="lblPreco">Preço Unit.</label>
                    <input type="number" id="precoUnitario" placeholder="0,00" step="0.00000001" onkeyup="calcularBidirecional('preco')">
                </div>
                <div class="input-group" style="flex:1" id="divQtd">
                    <label id="lblQtd">Quantidade</label>
                    <input type="number" id="qtd" placeholder="0" step="0.00000001" onkeyup="calcularBidirecional('qtd')">
                </div>
            </div>
            <div class="input-group">
                <label id="lblTotal">Total Investido (R$)</label>
                <input type="number" id="valorTotalInput" placeholder="0,00" step="0.01" onkeyup="calcularBidirecional('total')">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="fecharModal('modalAdd')">Cancelar</button>
                <button class="btn-confirm" onclick="salvarInvestimento()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalUpdate" class="modal">
        <div class="modal-content">
            <h3 class="form-title" id="updTitulo">Editar Ativo</h3>
            <input type="hidden" id="updId">
            <input type="hidden" id="updTipo">

            <div class="input-group">
                <label id="updLabelValor">Cotação Atual / Saldo</label>
                <input type="number" id="updValor" step="0.00000001">
                <small style="color:var(--text-secondary); font-size:0.7rem">Use para corrigir erros de API</small>
            </div>

            <div id="divUpdPosicao" style="display:none; border-top:1px solid var(--border-color); margin-top:10px; padding-top:10px;">
                <div class="input-row">
                    <div class="input-group" style="flex:1">
                        <label>Quantidade</label>
                        <input type="number" id="updQtd" step="0.00000001">
                    </div>
                    <div class="input-group" style="flex:1">
                        <label>Preço Médio (PM)</label>
                        <input type="number" id="updPM" step="0.00000001">
                    </div>
                </div>
            </div>

            <div id="divUpdInvestido" style="display:none; border-top:1px solid var(--border-color); margin-top:10px; padding-top:10px;">
                <div class="input-group">
                    <label>Valor Original Investido</label>
                    <input type="number" id="updInvestido" step="0.01">
                </div>
            </div>
            
            <div class="input-group" id="divUpdApiID" style="display:none; margin-top:10px; border-top:1px solid var(--border-color); padding-top:10px;">
                <label style="color:var(--accent-yellow)">ID CoinGecko (Correção)</label>
                <input type="text" id="updApiID" placeholder="Ex: bitcoin, pepe">
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="fecharModal('modalUpdate')">Cancelar</button>
                <button class="btn-confirm" style="background: var(--accent-green);" onclick="salvarAtualizacao()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div id="modalConfig" class="modal">
        <div class="modal-content">
            <h3 class="form-title">Configurações</h3>
            <div class="config-option" onclick="alternarTema()">
                <i class="fas fa-adjust" style="color: #90a4ae"></i>
                <div><div style="font-weight:bold">Alternar Tema</div><small style="color:var(--text-secondary)">Claro / Escuro</small></div>
            </div>
            <div class="config-option" onclick="exportarDados()">
                <i class="fas fa-download" style="color:var(--accent-blue)"></i>
                <div><div style="font-weight:bold">Fazer Backup</div><small style="color:var(--text-secondary)">Salvar dados no celular</small></div>
            </div>
            <label for="fileInput" class="config-option">
                <i class="fas fa-upload" style="color:var(--accent-green)"></i>
                <div><div style="font-weight:bold">Restaurar Backup</div><small style="color:var(--text-secondary)">Carregar arquivo salvo</small></div>
            </label>
            <input type="file" id="fileInput" class="hidden-file" accept=".json" onchange="importarDados(this)">
            <div class="config-option" onclick="confirmarReset()" style="border-color:var(--accent-red)">
                <i class="fas fa-trash" style="color:var(--accent-red)"></i>
                <div><div style="font-weight:bold; color:var(--accent-red)">Apagar Tudo</div><small style="color:var(--text-secondary)">Zerar aplicativo</small></div>
            </div>
            <button class="btn-cancel" style="width:100%; margin-top:10px" onclick="fecharModal('modalConfig')">Fechar</button>
        </div>
    </div>

    <div id="modalConfirmacao" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 id="confTitulo" class="form-title">Confirmação</h3>
            <p id="confMsg" style="color: var(--text-secondary); margin-bottom:20px;">Tem certeza?</p>
            <button id="btnConfSim" class="btn-danger" style="width:100%; margin-bottom: 10px; padding:15px;">Sim, Confirmar</button>
            <button class="btn-cancel" style="width:100%;" onclick="fecharModal('modalConfirmacao')">Cancelar</button>
        </div>
    </div>

    <div id="modalDelete" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 class="form-title" style="color: var(--accent-red);">Excluir Ativo</h3>
            <p style="color:var(--text-secondary);">Tem certeza? Isso é irreversível.</p>
            <input type="hidden" id="delId">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="fecharModal('modalDelete')">Não</button>
                <button class="btn-confirm" style="background: var(--accent-red);" onclick="confirmarExclusao()">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <script>
        const BRAPI_TOKEN = '4SyUvseEoazmZec7AAntHY'; 

        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => splash.style.visibility = 'hidden', 500);
            }, 1200);
            atualizarPrecosAutomaticamente();
        });

        const DB_KEY = 'invest_jeff_v10';
        const HIST_KEY = 'invest_jeff_history';
        const PRIV_KEY = 'invest_privacy';

        let carteira = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let historico = JSON.parse(localStorage.getItem(HIST_KEY)) || [];
        let privacidadeAtiva = localStorage.getItem(PRIV_KEY) === 'true';
        let chartPizza = null;
        let chartBarra = null;
        let callbackConfirmacao = null;

        carregarPref();
        render();
        atualizarIconeOlho();

        function render() {
            const lista = document.getElementById('listaAtivos');
            lista.innerHTML = '';
            
            let totalPatrimonio = 0; 
            let totalInvestido = 0; 
            let alocacao = {};
            
            carteira.forEach((item) => {
                let valorAtualTotal = 0, custoTotal = 0;
                if (item.tipo === 'RendaFixa') {
                    valorAtualTotal = item.precoAtualUnitario;
                    custoTotal = item.valorInvestidoOriginal; 
                } else {
                    valorAtualTotal = item.qtd * item.precoAtualUnitario;
                    custoTotal = item.qtd * item.precoMedioCompra;
                }
                totalPatrimonio += valorAtualTotal;
                totalInvestido += custoTotal;
                alocacao[item.tipo] = (alocacao[item.tipo] || 0) + valorAtualTotal;
            });

            const elTotal = document.getElementById('totalDisplay');
            elTotal.innerText = totalPatrimonio.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            elTotal.className = `valor-total ${privacidadeAtiva ? 'blur-text' : ''}`;
            
            const lucroGeral = totalPatrimonio - totalInvestido;
            const percGeral = totalInvestido > 0 ? (lucroGeral/totalInvestido)*100 : 0;
            const elLucro = document.getElementById('lucroTotalDisplay');
            elLucro.innerText = `${lucroGeral >= 0 ? '▲' : '▼'} ${percGeral.toFixed(2)}% (R$ ${lucroGeral.toFixed(2)})`;
            elLucro.style.background = lucroGeral >= 0 ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255, 82, 82, 0.2)';
            elLucro.style.color = lucroGeral >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            elLucro.className = privacidadeAtiva ? 'blur-text' : '';

            salvarHistorico(totalPatrimonio);
            renderGraficoPizza(alocacao);
            renderGraficoEvolucaoMensal();

            if(carteira.length === 0) {
                lista.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:30px">Carteira vazia.</p>';
                return;
            }

            const categoriasOrdem = ['Ação', 'FII', 'ETF', 'Cripto', 'RendaFixa'];
            // ALTERAÇÃO AQUI: "Criptomoedas"
            const nomesCat = {'Ação':'Ações', 'FII':'Fundos Imobiliários', 'ETF':'ETFs', 'Cripto':'Criptomoedas', 'RendaFixa':'Renda Fixa'};

            categoriasOrdem.forEach(catKey => {
                const itensCat = carteira.filter(i => i.tipo === catKey);
                if (itensCat.length > 0) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'categoria-wrapper';
                    
                    const header = document.createElement('div');
                    header.className = 'categoria-header';
                    header.onclick = () => toggleCategoria(catKey);
                    header.innerHTML = `<span>${nomesCat[catKey]}</span> <i id="icon-${catKey}" class="fas fa-chevron-down"></i>`;
                    
                    const content = document.createElement('div');
                    content.className = 'categoria-content';
                    content.id = `cat-content-${catKey}`;

                    itensCat.forEach(item => {
                        let valorAtualTotal = 0, custoTotal = 0;
                        if (item.tipo === 'RendaFixa') {
                            valorAtualTotal = item.precoAtualUnitario;
                            custoTotal = item.valorInvestidoOriginal; 
                        } else {
                            valorAtualTotal = item.qtd * item.precoAtualUnitario;
                            custoTotal = item.qtd * item.precoMedioCompra;
                        }
                        
                        const lucroReais = valorAtualTotal - custoTotal;
                        const lucroPorcentagem = custoTotal > 0 ? (lucroReais / custoTotal) * 100 : 0;
                        const cor = lucroReais >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                        const sinal = lucroReais >= 0 ? '+' : '';
                        const dataCompra = new Date(item.id).toLocaleDateString('pt-BR');
                        const blurClass = privacidadeAtiva ? 'blur-text' : '';
                        
                        let sub = item.tipo === 'RendaFixa' 
                            ? `Aporte: R$ ${custoTotal.toFixed(2)}` 
                            : `${formatarQtd(item.qtd)} un • PM: R$ ${formatarPreco(item.precoMedioCompra)}`;

                        const divItem = document.createElement('div');
                        divItem.className = 'ativo-card';
                        divItem.style.borderLeft = `4px solid ${getCor(item.tipo)}`;
                        divItem.innerHTML = `
                            <div class="ativo-info">
                                <h3>${item.nome}</h3>
                                <small class="${blurClass}">${sub}</small>
                            </div>
                            <div class="ativo-valores">
                                <div style="font-weight:bold; font-size:1.1rem;" class="${blurClass}">R$ ${valorAtualTotal.toLocaleString('pt-BR', {minimumFractionDigits:2})}</div>
                                <div style="display:flex; justify-content:flex-end; gap:8px; align-items:center;">
                                    <small style="color:${cor}; font-weight:bold; margin-right:5px;" class="${blurClass}">${sinal}${lucroPorcentagem.toFixed(1)}%</small>
                                    <button class="btn-cotacao" onclick="abrirModalUpdate(${item.id})"><i class="fas fa-pen"></i></button>
                                    <button onclick="abrirModalDelete(${item.id})" style="background:none; border:none; color:var(--text-secondary); font-size:1.2rem; cursor:pointer; padding:0 0 0 5px;">&times;</button>
                                </div>
                            </div>
                        `;
                        content.appendChild(divItem);
                    });

                    wrapper.appendChild(header);
                    wrapper.appendChild(content);
                    lista.appendChild(wrapper);
                }
            });
        }

        function toggleCategoria(catKey) {
            const content = document.getElementById(`cat-content-${catKey}`);
            const icon = document.getElementById(`icon-${catKey}`);
            content.classList.toggle('hidden');
            icon.parentElement.classList.toggle('collapsed');
        }

        function abrirModalUpdate(id) {
            const item = carteira.find(i => i.id === id);
            if (!item) return;

            document.getElementById('updId').value = id;
            document.getElementById('updTitulo').innerText = "Editar: " + item.nome;
            document.getElementById('updTipo').value = item.tipo;

            const divPosicao = document.getElementById('divUpdPosicao'); 
            const divInvestido = document.getElementById('divUpdInvestido'); 
            const divID = document.getElementById('divUpdApiID'); 
            const labelValor = document.getElementById('updLabelValor');

            if (item.tipo === 'RendaFixa') {
                divPosicao.style.display = 'none';
                divInvestido.style.display = 'block';
                divID.style.display = 'none';
                labelValor.innerText = "Saldo Total Atual (R$)";
                document.getElementById('updValor').value = item.precoAtualUnitario;
                document.getElementById('updInvestido').value = item.valorInvestidoOriginal;
            } else {
                divPosicao.style.display = 'block';
                divInvestido.style.display = 'none';
                labelValor.innerText = "Cotação Atual Unitária (R$)";
                document.getElementById('updValor').value = item.precoAtualUnitario;
                document.getElementById('updQtd').value = item.qtd;
                document.getElementById('updPM').value = item.precoMedioCompra;

                if (item.tipo === 'Cripto') {
                    divID.style.display = 'block';
                    document.getElementById('updApiID').value = item.apiID || '';
                } else {
                    divID.style.display = 'none';
                }
            }
            document.getElementById('modalUpdate').style.display = 'flex';
        }

        function salvarAtualizacao() {
            const id = parseInt(document.getElementById('updId').value);
            const index = carteira.findIndex(i => i.id === id);
            if(index === -1) return;

            const item = carteira[index];
            const novoValor = parseFloat(document.getElementById('updValor').value);
            
            if(!isNaN(novoValor)) {
                item.precoAtualUnitario = novoValor;
                if(item.tipo === 'RendaFixa') item.dataUltimaAtualizacao = new Date().toISOString().split('T')[0];
            }

            if(item.tipo === 'RendaFixa') {
                const novoInvestido = parseFloat(document.getElementById('updInvestido').value);
                if(!isNaN(novoInvestido)) item.valorInvestidoOriginal = novoInvestido;
            } else {
                const novaQtd = parseFloat(document.getElementById('updQtd').value);
                const novoPM = parseFloat(document.getElementById('updPM').value);
                if(!isNaN(novaQtd)) item.qtd = novaQtd;
                if(!isNaN(novoPM)) item.precoMedioCompra = novoPM;
                const manualID = document.getElementById('updApiID').value.toLowerCase().trim();
                if(item.tipo === 'Cripto' && manualID.length > 1) item.apiID = manualID;
            }

            salvarTudo(); fecharModal('modalUpdate'); 
        }

        async function buscarCotacaoAoCadastrar() {
            const tipo = document.getElementById('tipo').value;
            const nomeInput = document.getElementById('nomeAtivo');
            const loading = document.getElementById('loadingCotacao');
            const precoInput = document.getElementById('precoUnitario');
            const idInput = document.getElementById('cryptoID');
            if (tipo === 'RendaFixa' || nomeInput.value.length < 2) return;
            loading.style.display = 'block'; loading.innerText = 'Buscando...'; loading.style.color = 'var(--accent-blue)';
            const query = nomeInput.value.toLowerCase().trim();
            try {
                if (tipo === 'Cripto') {
                    const searchRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${query}`);
                    const searchData = await searchRes.json();
                    if (searchData.coins && searchData.coins.length > 0) {
                        const top = searchData.coins.sort((a, b) => (a.market_cap_rank||999)-(b.market_cap_rank||999)).slice(0, 5);
                        let found = false;
                        for (const coin of top) {
                            try {
                                const pRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coin.id}&vs_currencies=brl`);
                                const pData = await pRes.json();
                                if (pData[coin.id]) {
                                    precoInput.value = pData[coin.id].brl; idInput.value = coin.id;
                                    loading.innerText = `Encontrado: ${coin.name}`; loading.style.color = 'var(--accent-green)';
                                    calcularBidirecional('preco'); found = true; break;
                                }
                            } catch (e) {}
                        }
                        if (!found) throw new Error();
                    } else throw new Error();
                } else {
                    const ticker = nomeInput.value.toUpperCase().trim();
                    let url = `https://brapi.dev/api/quote/${ticker}?range=1d&interval=1d&fundamental=false&token=${BRAPI_TOKEN}`;
                    const res = await fetch(url); const data = await res.json();
                    if (data.results && data.results.length > 0) {
                        precoInput.value = data.results[0].regularMarketPrice;
                        loading.innerText = `Encontrado: R$ ${data.results[0].regularMarketPrice}`;
                        loading.style.color = 'var(--accent-green)';
                        calcularBidirecional('preco');
                    } else throw new Error();
                }
            } catch (e) { loading.innerText = "Não encontrado"; loading.style.color = "var(--accent-yellow)"; }
        }

        async function atualizarPrecosAutomaticamente() {
            const elLucro = document.getElementById('lucroTotalDisplay');
            let houveMudanca = false;

            const criptos = carteira.filter(i => i.tipo === 'Cripto');
            if (criptos.length > 0) {
                elLucro.innerText = "Atualizando Cripto...";
                const ids = criptos.filter(c => c.apiID).map(c => c.apiID).join(',');
                if (ids) {
                    try {
                        const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=brl`);
                        const data = await res.json();
                        criptos.forEach(item => { if (item.apiID && data[item.apiID]) { item.precoAtualUnitario = data[item.apiID].brl; houveMudanca = true; } });
                    } catch (e) {}
                }
                const semID = criptos.filter(c => !c.apiID);
                for (let item of semID) {
                    try {
                        const sRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${item.nome}`);
                        const sData = await sRes.json();
                        if (sData.coins && sData.coins.length > 0) {
                            const top1 = sData.coins[0];
                            const pRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${top1.id}&vs_currencies=brl`);
                            const pData = await pRes.json();
                            if (pData[top1.id]) { item.apiID = top1.id; item.precoAtualUnitario = pData[top1.id].brl; houveMudanca = true; }
                        }
                    } catch (e) {}
                    await new Promise(r => setTimeout(r, 1500));
                }
            }

            const ativosB3 = carteira.filter(i => ['Ação', 'FII', 'ETF'].includes(i.tipo));
            if (ativosB3.length > 0) {
                elLucro.innerText = "Atualizando B3...";
                const tickers = ativosB3.map(i => i.nome).join(',');
                try {
                    const res = await fetch(`https://brapi.dev/api/quote/${tickers}?range=1d&interval=1d&fundamental=false&token=${BRAPI_TOKEN}`);
                    const data = await res.json();
                    if (data.results) {
                        data.results.forEach(r => {
                            const item = carteira.find(i => i.nome === r.symbol);
                            if (item && r.regularMarketPrice) { item.precoAtualUnitario = r.regularMarketPrice; houveMudanca = true; }
                        });
                    }
                } catch (e) {}
            }

            const rf = carteira.filter(i => i.tipo === 'RendaFixa' && i.taxa && i.taxa.includes('CDI'));
            if (rf.length > 0) {
                elLucro.innerText = "Calculando CDI...";
                try {
                    const res = await fetch('https://brasilapi.com.br/api/taxas/v1');
                    const taxas = await res.json();
                    const cdi = taxas.find(t => t.nome === 'CDI')?.valor || 11.15;
                    const hoje = new Date().toISOString().split('T')[0];
                    rf.forEach(item => {
                        const match = item.taxa.match(/(\d+)%/);
                        const pct = match ? parseFloat(match[1])/100 : 1.0;
                        let last = item.dataUltimaAtualizacao || new Date(item.id).toISOString().split('T')[0];
                        if (last !== hoje) {
                            const dias = calcularDiasUteis(last, hoje);
                            if (dias > 0) {
                                const fator = Math.pow(1+(cdi/100), 1/252) - 1;
                                item.precoAtualUnitario = item.precoAtualUnitario * Math.pow(1 + (fator*pct), dias);
                                item.dataUltimaAtualizacao = hoje;
                                houveMudanca = true;
                            }
                        }
                    });
                } catch (e) {}
            }
            if (houveMudanca) salvarTudo(); else render();
        }

        function calcularDiasUteis(i, f) { let c=0; let d = new Date(i); const e = new Date(f); d.setDate(d.getDate()+1); while(d<=e){ const w=d.getDay(); if(w!==0&&w!==6)c++; d.setDate(d.getDate()+1); } return c; }
        function calcularBidirecional(o) {
            const tipo = document.getElementById('tipo').value;
            if (tipo === 'RendaFixa') return;
            const p = parseFloat(document.getElementById('precoUnitario').value);
            const q = parseFloat(document.getElementById('qtd').value);
            const t = document.getElementById('valorTotalInput');
            if (o==='qtd' && p) t.value=(p*q).toFixed(2);
            else if (o==='total' && p) document.getElementById('qtd').value=(parseFloat(t.value)/p).toFixed(8);
            else if (o==='preco' && q) t.value=(p*q).toFixed(2);
        }
        function abrirModalAdd() { 
            document.getElementById('nomeAtivo').value=''; document.getElementById('cryptoID').value='';
            document.getElementById('precoUnitario').value=''; document.getElementById('qtd').value='';
            document.getElementById('valorTotalInput').value=''; document.getElementById('taxa').value='';
            document.getElementById('loadingCotacao').style.display='none';
            document.getElementById('modalAdd').style.display='flex'; ajustarFormulario(); 
        }
        function fecharModal(id) { document.getElementById(id).style.display='none'; }
        function abrirModalDelete(id) { document.getElementById('delId').value=id; document.getElementById('modalDelete').style.display='flex'; }
        function confirmarExclusao() { carteira=carteira.filter(i=>i.id!==parseInt(document.getElementById('delId').value)); salvarTudo(); fecharModal('modalDelete'); }
        function salvarInvestimento() {
            const tipo = document.getElementById('tipo').value;
            const nome = document.getElementById('nomeAtivo').value.toUpperCase();
            if(!nome) return alert("Preencha o nome");
            let item = { id:Date.now(), tipo, nome, apiID:document.getElementById('cryptoID').value, qtd:0, precoMedioCompra:0, precoAtualUnitario:0, valorInvestidoOriginal:0, taxa:'', dataUltimaAtualizacao:new Date().toISOString().split('T')[0] };
            if (tipo === 'RendaFixa') {
                item.valorInvestidoOriginal = parseFloat(document.getElementById('valorTotalInput').value);
                item.precoAtualUnitario = item.valorInvestidoOriginal;
                item.taxa = document.getElementById('taxa').value;
            } else {
                item.precoMedioCompra = parseFloat(document.getElementById('precoUnitario').value);
                item.qtd = parseFloat(document.getElementById('qtd').value);
                item.precoAtualUnitario = item.precoMedioCompra;
            }
            if(!item.precoAtualUnitario) return alert("Valores inválidos");
            carteira.push(item); salvarTudo(); fecharModal('modalAdd');
        }
        function salvarTudo() { localStorage.setItem(DB_KEY, JSON.stringify(carteira)); render(); }
        function salvarHistorico(t) { 
            const hj = new Date().toISOString().split('T')[0]; 
            const ult = historico[historico.length-1]; 
            if(ult && ult.data===hj) ult.valor=t; else historico.push({data:hj, valor:t}); 
            localStorage.setItem(HIST_KEY, JSON.stringify(historico)); 
        }
        function togglePrivacidade() { privacidadeAtiva=!privacidadeAtiva; localStorage.setItem(PRIV_KEY, privacidadeAtiva); atualizarIconeOlho(); render(); }
        function atualizarIconeOlho() { const i=document.getElementById('eyeIcon'); i.className=privacidadeAtiva?'fas fa-eye-slash':'fas fa-eye'; i.style.color=privacidadeAtiva?'var(--accent-red)':'var(--text-color)'; }
        function carregarPref() { if(localStorage.getItem('tema')==='light') document.body.classList.add('light-mode'); }
        function alternarTema() { const l=document.body.classList.toggle('light-mode'); localStorage.setItem('tema',l?'light':'dark'); render(); }
        function abrirModalConfig() { document.getElementById('modalConfig').style.display='flex'; }
        function exportarDados() { const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({carteira,historico,versao:'17.1'})); const a=document.createElement('a'); a.href=d; a.download='backup.json'; document.body.appendChild(a); a.click(); a.remove(); }
        function importarDados(i) { const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{const d=JSON.parse(e.target.result); carteira=d.carteira; historico=d.historico||[]; salvarTudo(); fecharModal('modalConfig');}catch(e){alert('Erro');} }; r.readAsText(f); }
        function confirmarReset() { mostrarConfirmacao("Resetar?", "Apagar tudo?", ()=>{ localStorage.removeItem(DB_KEY); localStorage.removeItem(HIST_KEY); carteira=[]; historico=[]; render(); fecharModal('modalConfig'); }); }
        function mostrarConfirmacao(t,m,c) { document.getElementById('confTitulo').innerText=t; document.getElementById('confMsg').innerText=m; callbackConfirmacao=c; document.getElementById('modalConfirmacao').style.display='flex'; }
        function ajustarFormulario() {
            const t = document.getElementById('tipo').value; const n = document.getElementById('nomeAtivo'); const ln = document.getElementById('lblNome');
            document.getElementById('loadingCotacao').style.display='none'; document.getElementById('divTaxa').style.display='none';
            document.getElementById('precoUnitario').parentElement.style.display='flex'; document.getElementById('divQtd').style.display='flex';
            document.getElementById('stockLink').style.display = (t==='Cripto'||t==='RendaFixa')?'none':'block';
            if(t==='Cripto'){ ln.innerText="Nome Moeda"; n.placeholder="Ex: bitcoin"; document.getElementById('lblPreco').innerText="Cotação"; }
            else if(t==='RendaFixa'){ ln.innerText="Nome"; n.placeholder="Ex: CDB"; document.getElementById('divTaxa').style.display='flex'; document.getElementById('precoUnitario').parentElement.style.display='none'; document.getElementById('divQtd').style.display='none'; }
            else if(t==='FII') { ln.innerText="FII"; n.placeholder="Ex: MXRF11"; }
            else { ln.innerText="Ação"; n.placeholder="Ex: PETR4"; }
        }
        function traduzirTipo(t) { const m={'RendaFixa':'Renda Fixa','Ação':'Ações','FII':'Fundos Imobiliários','Cripto':'Criptomoedas','ETF':'ETFs'}; return m[t]||t; }
        function getCor(t) { const m={'RendaFixa':'#4CAF50','Ação':'#2196F3','FII':'#FFC107','Cripto':'#FF5722','ETF':'#9C27B0'}; return m[t]||'#999'; }
        function formatarPreco(v) { return v>1000?v.toLocaleString('pt-BR',{minimumFractionDigits:2}):v.toFixed(2); }
        function formatarQtd(v) { return v%1===0?v:v.toFixed(6); }
        function renderGraficoPizza(d) { const v=Object.values(d); const k=Object.keys(d); const t=v.reduce((a,b)=>a+b,0); const l=k.map((x,i)=>`${traduzirTipo(x)} (${t>0?((v[i]/t)*100).toFixed(1):0}%)`); if(chartPizza)chartPizza.destroy(); chartPizza=new Chart(document.getElementById('graficoAlocacao'),{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:k.map(getCor),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:document.body.classList.contains('light-mode')?'#333':'#aaa',boxWidth:10,font:{size:13}}}}}}); }
        
        // GRÁFICO MAIS FINO (maxBarThickness: 15)
        function renderGraficoEvolucaoMensal() { 
            const d={}; 
            historico.forEach(h=>{let m=""; if(h.data.includes('-')){const p=h.data.split('-');m=`${p[1]}/${p[0].slice(2)}`;}else{const p=h.data.split('/');m=`${p[1]}/${new Date().getFullYear().toString().slice(2)}`;} d[m]=h.valor;}); 
            const l=Object.keys(d); 
            const v=Object.values(d); 
            if(chartBarra)chartBarra.destroy(); 
            chartBarra=new Chart(document.getElementById('graficoEvolucao'),{
                type:'bar',
                data:{labels:l,datasets:[{label:'Patrimônio',data:v,backgroundColor:'#4CAF50',borderRadius:4, barPercentage: 0.5, categoryPercentage: 0.5, maxBarThickness: 15}]}, // <--- AJUSTADO AQUI
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#777'},grid:{display:false}},y:{ticks:{color:'#777'},grid:{color:'#444'}}}}
            }); 
        }
    </script>
    <script>if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js');}</script>
</body>
</html>
